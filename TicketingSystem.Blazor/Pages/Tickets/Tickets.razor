@page "/tickets"
@using Microsoft.AspNetCore.Authorization
@using System.Net.Http.Json
@using TicketingSystem.Blazor.Models.DTOs
@attribute [Authorize]
@inject HttpClient Http
@inject NavigationManager Nav
@inject ISnackbar Snackbar

<MudContainer MaxWidth="MaxWidth.Large" Class="mt-8">
    <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center" Class="mb-6">
        <div>
            <MudText Typo="Typo.h4" Color="Color.Primary">Tichetele Mele</MudText>
            <MudText Typo="Typo.body2">Gestionează solicitările tale de suport.</MudText>
        </div>
        <MudButton Variant="Variant.Filled" Color="Color.Primary"
                   StartIcon="@Icons.Material.Filled.Add"
                   OnClick='() => Nav.NavigateTo("/tickets/add")'>
            Tichet Nou
        </MudButton>
    </MudStack>

    <MudTable Items="@_tickets" Hover="true" Loading="@(_tickets == null)" Elevation="2">
        <HeaderContent>
            <MudTh>Titlu</MudTh>
            <MudTh>Status</MudTh>
            <MudTh>Creat la</MudTh>
            <MudTh Style="text-align:right">Acțiuni</MudTh>
        </HeaderContent>
        <RowTemplate>
            <MudTd DataLabel="Titlu"><b>@context.Title</b></MudTd>
            <MudTd DataLabel="Status">
                <MudChip T="string" Color="@GetStatusColor(context.Status)" Size="Size.Small" Variant="Variant.Filled">@context.Status</MudChip>
            </MudTd>
            <MudTd DataLabel="Creat la">@context.CreatedAt.ToString("dd.MM.yyyy")</MudTd>
            <MudTd DataLabel="Acțiuni" Style="text-align:right">
                <MudIconButton Icon="@Icons.Material.Filled.Visibility" Color="Color.Info"
                               OnClick="@(() => Nav.NavigateTo($"/tickets/details/{context.Id}"))" />
            </MudTd>
        </RowTemplate>
        <NoRecordsContent>
            <MudText Class="pa-4">Momentan nu există tichete.</MudText>
        </NoRecordsContent>
        <PagerContent>
            <MudTablePager RowsPerPageString="Rânduri:" />
        </PagerContent>
    </MudTable>
</MudContainer>

@code {
    private List<TicketDto>? _tickets;

    protected override async Task OnInitializedAsync()
    {
        try
        {
            _tickets = await Http.GetFromJsonAsync<List<TicketDto>>("api/tickets/my-tickets");
        }
        catch
        {
            Snackbar.Add("Eroare la conectarea cu serverul.", Severity.Error);
            _tickets = new();
        }
    }

    private Color GetStatusColor(string s) => s switch
    {
        "Nou" => Color.Info,
        "În Lucru" => Color.Warning,
        "Rezolvat" => Color.Success,
        _ => Color.Default
    };
}